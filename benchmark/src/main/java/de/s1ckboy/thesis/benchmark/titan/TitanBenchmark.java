package de.s1ckboy.thesis.benchmark.titan;

import java.util.ArrayList;
import java.util.List;

import com.thinkaurelius.titan.core.TitanGraph;
import com.thinkaurelius.titan.graphdb.relations.RelationIdentifier;
import com.tinkerpop.blueprints.Edge;
import com.tinkerpop.blueprints.Vertex;

import de.s1ckboy.thesis.benchmark.Benchmark;
import de.s1ckboy.thesis.benchmark.Configs;
import de.s1ckboy.thesis.benchmark.Constants;

public abstract class TitanBenchmark extends Benchmark {

    protected TitanGraph graphDB;

    protected List<RelationIdentifier> reviewIDs;

    protected long[] ids = new long[] { 654736, 234980, 69832, 527496, 709612,
	    781184, 846104, 338812, 358144, 798816, 185744, 806464, 521640,
	    235672, 788744, 839416, 459040, 523044, 798816, 405384, 209196,
	    366152, 528160, 250052, 518908, 805144, 36560, 824200, 459040,
	    358144, 307208, 786868, 304112, 57804, 384400, 781020, 779200,
	    657968, 466860, 405384, 174764, 96868, 470716, 257544, 667508,
	    836676, 631268, 447920, 585200, 461612, 326904, 33528, 143924,
	    589888, 621936, 557736, 141760, 135372, 497848, 657968, 372796,
	    585200, 303256, 471644, 557736, 160520, 366152, 645112, 634564,
	    373532, 489448, 616096, 720532, 405384, 191484, 727916, 771216,
	    785540, 446936, 632992, 227448, 32944, 576864, 420608, 275372,
	    841848, 575120, 612276, 634564, 344316, 366152, 258292, 441712,
	    748680, 531108, 340844, 102440, 779200, 470716, 164272, 96540,
	    771216, 435916, 324768, 522660, 621664, 301792, 780320, 723764,
	    481584, 290908, 819100, 170600, 143984, 160520, 742904, 245948,
	    564916, 549692, 45812, 265308, 824200, 786596, 595288, 409356,
	    168792, 384400, 631292, 187568, 541464, 748344, 844756, 82172,
	    121972, 673392, 402376, 257544, 289316, 659780, 170600, 557736,
	    697152, 356092, 621936, 361632, 489448, 234980, 751680, 621936,
	    76908, 435716, 422248, 540080, 654736, 705028, 37316, 779200,
	    621936, 470716, 771216, 604008, 591296, 705900, 44284, 104212,
	    528160, 274972, 362160, 500392, 405384, 404940, 407028, 390624,
	    727916, 619632, 517872, 667572, 197068, 262088, 654736, 527496,
	    373304, 526508, 719712, 171872, 171540, 485084, 482440, 242796,
	    600308, 257544, 589860, 200560, 1708, 613028, 143924, 514164,
	    841848, 315168, 467268, 366152, 791244, 70436, 779104, 771216,
	    284224, 595288, 592096, 50528, 585172, 621936, 81476, 827180,
	    104212, 258292, 123900, 725404, 326904, 9216, 594764, 682660,
	    153024, 314528, 512180, 25180, 114608, 822636, 264648, 389920,
	    768976, 612276, 347108, 695856, 186736, 235244, 554224, 482460,
	    600308, 508296, 528160, 771216, 518908, 616096, 695856, 279660,
	    500192, 612276, 681016, 19432, 496312, 141460, 426956, 25180,
	    55876, 46456, 156972, 773020, 597460, 282348, 595288, 785276,
	    549580, 477716, 166436, 648868, 767012, 604008, 315292, 294776,
	    141480, 662688, 85080, 328468, 781184, 667572, 369396, 476924,
	    36560, 600308, 653616, 505828, 368480, 576280, 124104, 788744,
	    75396, 44284, 651872, 712168, 491408, 821864, 46704, 23824, 621936,
	    836676, 839804, 448444, 459040, 762088, 69832, 434412, 271140,
	    768976, 595288, 160520, 381376, 143924, 798372, 597460, 1708,
	    237020, 604368, 36468, 575120, 146636, 712340, 677284, 841848,
	    654736, 344656, 285592, 467268, 407948, 568292, 187108, 779200,
	    654736, 788744, 162160, 655724, 597460, 55236, 432540, 146636,
	    654364, 674612, 647024, 278464, 81476, 354100, 557736, 782176,
	    223424, 275156, 481584, 349816, 628728, 836676, 169388, 433136,
	    607776, 821864, 634564, 612276, 408092, 677956, 788744, 508036,
	    33936, 143924, 489448, 379560, 786596, 557736, 173552, 466860,
	    540080, 804800, 841848, 798816, 433136, 281464, 70032, 712340,
	    631292, 450324, 100560, 704660, 276184, 701920, 845448, 188476,
	    267920, 567228, 595288, 619632, 32944, 576280, 527496, 576864,
	    433136, 671864, 564916, 27712, 69832, 336312, 712340, 467928,
	    771216, 18920, 12528, 143924, 657188, 487788, 616096, 416300,
	    60172, 510824, 459040, 281728, 768976, 673392, 576280, 702924,
	    303836, 576788, 798816, 778848, 705900, 275072, 698312, 81476,
	    836676, 290628, 767644, 768976, 580728, 9216, 511192, 326904,
	    467268, 427708, 330132, 607724, 202008, 381376, 712340, 104212,
	    405384, 688656, 254688, 585040, 427708, 459040, 616040, 423636,
	    75396, 843136, 481584, 274972, 630240, 548672, 160520, 160520,
	    347108, 834244, 786216, 51260, 701924, 702924, 81364, 534556,
	    752272, 553548, 326904, 382076, 597460, 326904, 705900, 577044,
	    409508, 326904, 727916, 304812, 657968, 631292, 830984, 492128,
	    607264, 405384, 575120, 788744, 466244, 249672, 621936, 330248,
	    415424, 465028, 367148, 727916, 58220, 653616, 237728, 576280,
	    44284, 276576, 757804, 666044, 81476, 599360, 32944, 616096,
	    600308, 602988, 432580, 621220, 749392, 113020, 621936, 824948,
	    556092, 639580, 154364, 257544, 404940, 395716, 69832, 459744,
	    444688, 543952, 465028, 467268, 274972, 465828, 104212, 750408,
	    86780, 755636, 428456, 727916, 637148, 441712, 629220, 32944,
	    575120, 36560, 279572, 489448, 386264, 668488, 711712, 284832,
	    380196, 187420, 739340, 527496, 160520, 404940, 374528, 814556,
	    375888, 539752, 497328, 654736, 634564, 813204, 545652, 786232,
	    836676, 564916, 9216, 405384, 523756, 212860, 733784, 25156,
	    769884, 58220, 388860, 1708, 83816, 465028, 824200, 667572, 393220,
	    213292, 234744, 619632, 540080, 781184, 604008, 25180, 607724,
	    200676, 438796, 64848, 510824, 573160, 170596, 836676, 86216,
	    469548, 293064, 788744, 272220, 506884, 619632, 73352, 140564,
	    339200, 194976, 402976, 634564, 75396, 424352, 621652, 492832,
	    644096, 757776, 695636, 168996, 32904, 358144, 789640, 705900,
	    611532, 673392, 605272, 461412, 32900, 216324, 808608, 758824,
	    523756, 470716, 397340, 616096, 844428, 581524, 673392, 410100,
	    344656, 825632, 798816, 81572, 53944, 295088, 836676, 629992,
	    81476, 345664, 255440, 326904, 459040, 143924, 484524, 673392,
	    98136, 746540, 600308, 404940, 338568, 789640, 657188, 381376,
	    320880, 786596, 585512, 813404, 65824, 768976, 616288, 643560,
	    602988, 653616, 476800, 557736, 10092, 55644, 841848, 147532,
	    786868, 103412, 418992, 267496, 188804, 634004, 324628, 510824,
	    178836, 63632, 277412, 25196, 340908, 81476, 619632, 837448,
	    702924, 798816, 336656, 381376, 702840, 107496, 743288, 170600,
	    531476, 757956, 705900, 76908, 694112, 304108, 472360, 489448,
	    680668, 276340, 512484, 620588, 528160, 775620, 619632, 385536,
	    241396, 376624, 239772, 710532, 572500, 688656, 262936, 530512,
	    146636, 9216, 339200, 725404, 405384, 403592, 589764, 465028,
	    21396, 823784, 299596, 595288, 326904, 594764, 489448, 480176,
	    518048, 145508, 478636, 395716, 230628, 433136, 523756, 224896,
	    276468, 527496, 314808, 595288, 560128, 544980, 257544, 427708,
	    564916, 9216, 71120, 2160, 336656, 472360, 587348, 432812, 841968,
	    534556, 785840, 788744, 49560, 256264, 779200, 651872, 644776,
	    727916, 259968, 347108, 151452, 465028, 615112, 631292, 467268,
	    819100, 284224, 460348, 289316, 757956, 66904, 607724, 76908,
	    427708, 612276, 118588, 841848, 743288, 581904, 654136, 540080,
	    768976, 36560, 372740, 282580, 689408, 607724, 354128, 657188,
	    543412, 576280, 15052, 513900, 518908, 381376, 540080, 428032,
	    375640, 701892, 58220, 152132, 72716, 240868, 667572, 134312,
	    100224, 561912, 69832, 81476, 311748, 404940, 125812, 585200,
	    609204, 43100, 391840, 621936, 781020, 595288, 775508, 160520,
	    595288, 146676, 771356, 722212, 585308, 50360, 806144, 557736,
	    634564, 824200, 274476, 824200, 340188, 588288, 466860, 724372,
	    308244, 681788, 788744, 782676, 781020, 404940, 236996, 552520,
	    784624, 712112, 234980, 326904, 836676, 779200, 75244, 395716,
	    284224, 404940, 685252, 576280, 341240, 712340, 426056, 104212,
	    257544, 667572, 58008, 824200, 841848, 369020, 72916, 181808,
	    358144, 657188, 230932, 575120, 531388, 440856, 58660, 61428,
	    631292, 470716, 634564, 557736, 762724, 557736, 774872, 555592,
	    404940, 146636, 768976, 727916, 194976, 347108, 69832, 739024,
	    238364, 47372, 448444, 665940, 471704, 170600, 44284, 567864,
	    757956, 653616, 524936, 835440, 285604, 209728, 368136, 146636,
	    805028, 178836, 657188, 146636, 657188, 470716, 773472, 293276,
	    69832, 284224, 82308, 313316, 489540, 830564, 258332, 727916,
	    519884, 765956, 234980, 2400, 339200, 665836, 702924, 29120,
	    673392, 388552, 384400, 405384, 506884, 358312, 395716, 534556,
	    146636, 246584, 32944, 12752, 505012, 523756, 753504, 751844,
	    429792, 15212, 737512, 386756, 674704, 647208, 206796, 75900,
	    802356, 397340, 69832, 225312, 80736, 173452, 433028, 170600,
	    481584, 493156, 635188, 280248, 344656, 506884, 540080, 470716,
	    358144, 349732, 784088, 657968, 597460, 459040, 613660, 218300,
	    835440, 252320, 695856, 585200, 812672, 692468, 530764, 459040 };

    @Override
    public void setUp() {
	cfg = Configs.get(TitanConstants.INSTANCE_NAME);
	graphDB = TitanHelper.getGraphDB(cfg);

	reviewIDs = new ArrayList<RelationIdentifier>();

	super.setUp();
    }

    @Override
    public void beforeRun() {
	// TODO Auto-generated method stub
    }

    @Override
    public void afterRun() {
	// TODO Auto-generated method stub
    }

    @Override
    public void warmup() {
	log.info("Warming up the caches ...");
	String type;
	int commitSize = cfg.getInt("warmup.commit-size");
	int logSize = cfg.getInt("warmup.log-size");
	long cnt = 0L;
	for (Vertex v : graphDB.getVertices()) {
	    type = v.getProperty(Constants.KEY_NODE_EDGE_TYPE);
	    if (type.equals(Constants.VALUE_TYPE_GROUP)) {
		groupIDs.add((Long) v.getId());
	    } else if (type.equals(Constants.VALUE_TYPE_PRODUCT)) {
		productIDs.add((Long) v.getId());
	    } else if (type.equals(Constants.VALUE_TYPE_USER)) {
		userIDs.add((Long) v.getId());
	    }

	    if (++cnt % logSize == 0) {
		log.info("touched " + cnt + " nodes");
	    }
	    if (cnt % commitSize == 0) {
		graphDB.commit();
	    }
	}
	cnt = 0L;
	graphDB.commit();

	for (Edge e : graphDB.getEdges()) {
	    type = e.getLabel();
	    if (type.equals(Constants.LABEL_EDGE_REVIEWED_BY)) {
		reviewIDs.add((RelationIdentifier) e.getId());
	    }
	    if (++cnt % logSize == 0) {
		log.info("touched " + cnt + " edges");
		graphDB.commit();
	    }
	    if (cnt % commitSize == 0) {
		graphDB.commit();
	    }
	}
	log.info("Products: " + productIDs.size());
	log.info("Groups: " + groupIDs.size());
	log.info("Users: " + userIDs.size());
	log.info("Reviews: " + reviewIDs.size());
	log.info("done");
    }

    @Override
    public void tearDown() {
	TitanHelper.closeGraphDB();
    }

    @Override
    public String getDatabaseName() {
	return TitanConstants.INSTANCE_NAME;
    }
}
